<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Peta Futuristik Multi-Layer</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<style>

  :root {
  /* === PALETTE LIGHT-THEME FUTURISTIC === */
  --primary-bg: var(--sidebar-bg, rgba(37, 31, 74, 0.901));  /* Panel background */
  --accent-color: var(--neon-blue, #4f46e5);                 /* Header & active label */
  --text-color: var(--text, #1e293b);                        /* Teks utama */
  --input-bg: rgba(231, 226, 255, 0.881);                         /* Input/Select bg lembut */
  --input-focus-bg: rgba(226,232,240,0.95);                  /* Input fokus */
  --input-shadow: rgba(79,70,229,0.3);                       /* Inner shadow */
  --hover-bg: rgba(79,70,229,0.1);                            /* Hover background */
  --button-bg: var(--gradient-primary, linear-gradient(135deg,#4f46e5,#7c3aed));
  --button-hover-bg: linear-gradient(135deg,#6366f1,#7c3aed);
  --swap-bg: rgba(79,70,229,0.2);
  --swap-hover-shadow: #6366f1;
}


/* === BODY & MAP === */
body {
  margin: 0;
  padding: 0;
}

#map {
  height: 90vh;
  width: 100%;
  margin: 0;
  border-radius: 15px;
  box-shadow: 0 0 20px rgba(38, 0, 255, 0.5);
  transition: all 0.5s ease;
}

/* === CONTAINER === */
.map-container {
  display: flex;
  flex-direction: row;
  width: 95%;
  margin: 30px auto;
  gap: 15px;
  min-height: 70vh;
}

/* === PANEL CONTROLS === */
.controls {
  position: static;
  z-index: 1000;
  background: var(--primary-bg);
  padding: 30px;
  box-shadow: 0 0 15px var(--accent-color), 0 0 30px rgba(38,0,255,0.4);
  border: 1px solid rgba(80,32,255,0.6);
  border-radius: 15px;
  backdrop-filter: blur(10px);
  display: flex;
  flex-direction: column;
  gap: 12px;
  width: 250px;
  min-width: 250px;
  font-family: 'Arial', sans-serif;
  font-weight: bold;
  font-size: 15px;
  color: var(--text-color);
  transition: all 0.5s ease;
}

.controls div {
  display: flex;
  flex-direction: column;
  width: 100%;
  gap: 5px;
}

.controls h3 {
  margin: 0 0 10px 0;
  color: var(--accent-color);
  border-bottom: 1px solid rgba(38,0,255,0.3);
  padding-bottom: 10px;
  font-size: 1.2em;
  letter-spacing: 1px;
  text-align: center;
}

.controls div.input-container {
  display: flex;
  flex-direction: column;
  width: 90%;
  gap: 5px;
  position: relative;
}

.controls label {
  font-size: 0.85em;
  font-weight: bold;
  color: #999bff;
}

.controls input,
.controls select {
  padding: 10px;
  border: none;
  border-radius: 6px;
  background: var(--input-bg);
  color: var(--text-color);
  box-shadow: 0 0 5px var(--input-shadow) inset;
  transition: all 0.3s;
  font-weight: 500;
}

.controls input:focus,
.controls select:focus {
  background: var(--input-focus-bg);
  box-shadow: 0 0 10px rgba(30,0,255,0.6) inset, 0 0 5px var(--input-shadow);
  outline: none;
}

.location-icon {
  color: #4800ff;
  text-shadow: 0 0 8px #3300ff7c;
  font-size: 1.2em;
  margin-right: 5px;
}

/* === VEHICLE SLIDER === */
.input-container .vehicle-slider {
  display: flex !important;
  flex-direction: row !important;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
}

.input-container .vehicle-slider .vehicle-label {
  flex: 1;
  text-align: center;
}

.vehicle-slider {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--);
  border-radius: 10px;
  box-shadow: 0 0 8px rgba(13,0,255,0.3) inset;
  padding: 1px;
  gap: 10px;
}

.vehicle-slider input[type="radio"] {
  display: none;
}

.vehicle-label {
  flex: 1;
  text-align: center;
  padding: 12px 0;
  cursor: pointer;
  border-radius: 6px;
  font-size: 1.3em;
  color: #3b3e6c;
  opacity: 0.6;
  transition: all 0.3s ease;
  background: rgba(38,0,255,0.05);
  user-select: none;
}

.vehicle-label:hover {
  opacity: 1;
  color: #5500ff;
  background: var(--hover-bg);
  transform: scale(1.03);
}

.vehicle-slider input[type="radio"]:checked + .vehicle-label {
  background: linear-gradient(135deg, #6600ff, #5500ff);
  color: #151520;
  box-shadow: 0 0 15px rgba(47,0,255,0.8), inset 0 0 8px rgba(0,0,0,0.5);
  transform: scale(1.07);
  opacity: 1;
}

/* === BUTTONS === */
.controls button#routeBtn {
  padding: 8px 20px;
  border-radius: 8px;
  background: var(--button-bg);
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  border: none;
  box-shadow: 0 0 15px rgba(68,0,255,0.5);
  transition: all 0.3s;
  text-transform: uppercase;
  margin-top: 10px;
}

.controls button#routeBtn:hover {
  background: var(--button-hover-bg);
  box-shadow: 0 0 25px rgba(81,0,255,0.8);
  transform: translateY(-1px);
}

/* === SWAP BUTTON === */
#swapBtn {
  grid-column: 1 / -1;
  margin: -10px -20px -30px 225px;
  padding: 5px 10px;
  font-size: 1rem;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--swap-bg);
  border: 1px solid #8c7aff;
  box-shadow: 0 0 10px #5d00ff88;
  color: #a872ff;
  cursor: pointer;
  transition: all 0.3s;
  outline: none;
}

#swapBtn:hover {
  box-shadow: 0 0 20px var(--swap-hover-shadow);
  transform: rotate(360deg) scale(1.1);
}

#swapBtn:active {
  background: linear-gradient(45deg, #875bff, #4c00ff);
  color: #151520;
}




/* --- IKON DASAR (Ini akan di-override oleh kelas spesifik di bawah) --- */
.futuristic-icon {
    border: 1.5px solid rgba(27, 27, 27, 0.688); 
    border-radius: 50%; 
    box-shadow: 0 0 5px rgba(29, 29, 29, 0.7);
    transition: box-shadow 0.3s ease-in-out, transform 0.3s ease-in-out, border-color 0.3s ease-in-out;
}

/* -------------------------------------------------------------------------- */
/* --- DEFINISI WARNA SPESIFIK BERDASARKAN KATEGORI --- */
/* -------------------------------------------------------------------------- */

/* 1. WARNA ALAM (HIJAU NEON) */
.icon-nature {
    background: linear-gradient(135deg, rgba(138, 251, 155, 0.892), rgba(63, 229, 113, 0.7)); 
    border: 1.5px solid rgba(27, 27, 27, 0.688); /* Border Hijau Pastel 2px */
    border-radius: 50%; /* Membuat border berbentuk lingkaran */
}
.icon-nature:hover {
    box-shadow: 0 0 10px rgba(0, 255, 150, 0.9), 0 0 20px rgba(0, 200, 100, 0.6);
    border-color: rgba(0, 255, 150, 1.0); 
    transform: scale(1.1);
}
.icon-nature.marker-active, .icon-nature.marker-active:hover { 
   box-shadow: 0 0 10px rgba(0, 255, 150, 0.9), 0 0 20px rgba(0, 200, 100, 0.6);
    border-color: rgba(0, 255, 150, 1.0); 
    border-width: 4px; 
    transform: scale(1.15); 
}

/* 2. WARNA KULINER */
.icon-culinary {
    background: linear-gradient(135deg, rgba(135, 187, 250, 0.892), rgba(0, 174, 255, 0.7)); 
    border: 1.5px solid rgba(27, 27, 27, 0.688); /* Border Hijau Pastel 2px */
    border-radius: 50%; /* Membuat border berbentuk lingkaran */
}
.icon-culinary:hover {
     box-shadow: 0 0 10px rgba(0, 150, 255, 0.9), 0 0 20px rgba(0, 100, 200, 0.6); /* Glow Biru */
    border-color: rgba(0, 150, 255, 1.0); 
    transform: scale(1.1);
}
.icon-culinary.marker-active, .icon-culinary.marker-active:hover { 
     box-shadow: 0 0 10px rgba(0, 150, 255, 0.9), 0 0 20px rgba(0, 100, 200, 0.6); /* Glow Biru */
    border-color: rgba(0, 150, 255, 1.0);
    border-width: 4px; 
    transform: scale(1.15); 
}

/* 3. WARNA BUDAYA/SEJARAH */
.icon-history {
    background: linear-gradient(135deg, rgba(255, 150, 138, 0.892), rgba(255, 99, 71, 0.7)); 
    border: 1.5px solid rgba(27, 27, 27, 0.688); /* Border Hijau Pastel 2px */
    border-radius: 50%; /* Membuat border berbentuk lingkaran */
}
.icon-history:hover {
    box-shadow: 0 0 10px rgba(255, 100, 0, 0.9), 0 0 20px rgba(255, 50, 0, 0.6); /* Glow Orange */
    border-color: rgba(255, 100, 0, 1.0);  
    transform: scale(1.1);
}
.icon-history.marker-active, .icon-history.marker-active:hover { 
     box-shadow: 0 0 10px rgba(255, 100, 0, 0.9), 0 0 20px rgba(255, 50, 0, 0.6); /* Glow Orange */
    border-color: rgba(255, 100, 0, 1.0);  
    transform: scale(1.1);
    border-width: 4px; 
    transform: scale(1.15); 
}

/* 4. WARNA REKREASI/HIBURAN (UNGU/MAGENTA NEON) */
.icon-recreation {
    background: linear-gradient(135deg, rgba(135, 206, 250, 0.892), rgba(0, 255, 255, 0.7)); 
    border: 1.5px solid rgba(27, 27, 27, 0.688); /* Border Hijau Pastel 2px */
    border-radius: 50%; /* Membuat border berbentuk lingkaran */
}
.icon-recreation:hover {
    box-shadow: 0 0 10px rgba(0, 255, 255, 0.9), 0 0 20px rgba(0, 200, 200, 0.6); /* Glow Cyan/Elektrik */
    border-color: rgba(0, 255, 255, 1.0); 
    transform: scale(1.1);
}
.icon-recreation.marker-active, .icon-recreation.marker-active:hover { 
   box-shadow: 0 0 10px rgba(0, 255, 255, 0.9), 0 0 20px rgba(0, 200, 200, 0.6); /* Glow Cyan/Elektrik */
    border-color: rgba(0, 255, 255, 1.0); 
    border-width: 4px; 
    transform: scale(1.15); 

}

/* Definisikan kelas kustom yang Anda tambahkan di JavaScript */
.custom-popup-glow .leaflet-popup-content-wrapper {
    /* Hapus bayangan default di sini karena Anda sudah mendefinisikannya di HTML inline */
    transition: box-shadow 0.3s ease-in-out, opacity 0.3s ease-in-out;
}

/* Aturan untuk Efek Glow saat kursor di atas pop-up */
.custom-popup-glow:hover .leaflet-popup-content-wrapper {
    /* Matikan properti opacity:80% di HTML inline agar efek ini terlihat jelas */
    opacity: 100% !important; 
    
    /* Efek Glow: Menggunakan box-shadow dengan warna terang */
    box-shadow: 
        0 4px 15px rgba(0, 255, 255, 0.7), /* Glow utama (Cyan) */
        0 0 25px rgba(0, 200, 255, 0.4); /* Glow sekunder (Biru Muda) */
}


/* --- STYLE KONTROL LAPISAN (L.control.layers) --- */

.leaflet-control-layers {
    /* Background dan Border */
    background: rgba(20, 20, 30, 0.95) !important; /* Sama seperti sidebar, lebih gelap */
    border: 1px solid rgba(0, 255, 255, 0.6) !important; /* Border Neon */
    border-radius: 10px !important;
    box-shadow: 0 0 10px rgba(0, 255, 255, 0.5) !important;
    backdrop-filter: blur(5px);
    color: #e9ffff; /* Warna teks putih neon */
    font-size: 14px;
    font-weight: 500;
}

/* Header Layers (Saat diklik, muncul daftar lapisan) */
.leaflet-control-layers-expanded {
    padding: 10px;
    background: rgba(20, 20, 30, 0.95) !important; /* Pastikan background tetap gelap saat terbuka */
}

/* Style saat mouse di atas kontrol */
.leaflet-control-layers:hover {
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.8), 0 0 20px rgba(0, 128, 255, 0.5) !important;
}

/* Checkbox/Radio Button Style */
.leaflet-control-layers label {
    margin: 5px 0;
    cursor: pointer;
    border-bottom: 1px dashed rgba(0, 255, 255, 0.2);
    padding-bottom: 3px;
    transition: color 0.3s;
}

.leaflet-control-layers label:hover {
    color: #00ffff; /* Efek hover neon pada teks */
}

/* Hapus padding dan margin berlebihan dari list item */
.leaflet-control-layers-base label {
    display: block;
}
.leaflet-control-layers-separator {
    display: none; /* Sembunyikan garis pemisah default */
}






.leaflet-fullscreen-on .map-container {
  flex-direction: column;
  width: 100%;
  height: 100vh;
  margin: 0;
  gap: 0;
}
.leaflet-fullscreen-on #map {
  width: 100%;
  height: 100vh;
  border-radius: 0;
  margin: 0;
}
.leaflet-fullscreen-on .controls {
  position: absolute;
  top: 45px;
  left: 50%;
  transform: translateX(-50%);
  flex-direction: row;
  width: auto;
  padding: 12px 20px;
  background: rgba(20, 20, 30, 0.75);
  z-index: 9000;
}
.leaflet-fullscreen-on .controls input,
.leaflet-fullscreen-on .controls select {
  width: 140px;
}
.leaflet-fullscreen-on .controls div {
  flex-direction: row;
  align-items: center;
  width: auto;
}
.leaflet-fullscreen-on .controls div label {
  margin-right: 5px;
}

/* ================================= */
/* === GAYA UNTUK TOMBOL LOKASI SAYA === */
/* ================================= */
#locateBtn {
    width: 100%; /* Lebar tombol penuh */
    padding: 12px;
    margin-bottom: 15px; /* Memberi jarak dengan input di bawahnya */
    
    font-size: 1em;
    font-weight: bold;
    color: #e0e0ff; /* Warna teks ungu muda */
    
    background: rgba(79, 70, 229, 0.2); /* Latar belakang ungu transparan, serasi dengan tombol swap */
    border: 1px solid #8c7aff; /* Border ungu neon */
    border-radius: 8px; /* Sudut melengkung */
    
    cursor: pointer;
    transition: all 0.3s ease;

    /* Untuk menengahkan ikon dan teks */
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

#locateBtn:hover {
    color: #ffffff; /* Teks menjadi putih saat di-hover */
    background: rgba(79, 70, 229, 0.4); /* Latar belakang lebih pekat */
    box-shadow: 0 0 15px var(--swap-hover-shadow); /* Efek glow seperti tombol swap */
}



</style>
</head>
<body>


    
<div class="map-container">
    <div class="controls">
        <h3>ROUTE & EXPLORE üöÄ</h3>
        
        <div class="input-container">
            <button id="locateBtn">üìç My Location</button>
            <label for="startLocation">START LOCATION <span class="location-icon"></span> </label>
            <input type="text" id="startLocation" placeholder="Type Start Location">
            <div id="startSuggestions" class="suggestions"></div>
        </div>

        <button id="swapBtn" title="Tukar Lokasi">‚áÑ</button>

        <div class="input-container">
            <label for="endLocation">DESTINATION</label>
            <input type="text" id="endLocation" placeholder="Type Destination">
            <div id="endSuggestions" class="suggestions"></div>
        </div>
    
        <div class="input-container">
            <label>VEHICLE</label>
            <div id="vehicle-select" class="vehicle-slider">
                <input type="radio" id="car" name="vehicle" value="car" checked>
                <label for="car" class="vehicle-label" title="Car">üöó</label>

                <input type="radio" id="motorbike" name="vehicle" value="motorcycle">
                <label for="motorbike" class="vehicle-label" title="Motorcycle">üèçÔ∏è</label>

                <input type="radio" id="foot" name="vehicle" value="foot">
                <label for="foot" class="vehicle-label" title="Foot">üö∂</label>
            </div>
        </div>
        
        <div class="input-container">
            <label>&nbsp;</label> <button id="routeBtn">FIND ROUTE</button>
        </div>
    </div> 

    <!-- Pindahkan div map ke sini, sejajar dengan controls -->
    <div id="map"></div> 
</div>


    



<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>

// ====================================================================
// 1. INISIALISASI PETA & LOGIKA GLOBAL
// ====================================================================
const map = L.map('map').setView([-6.9034, 107.6186], 10); 
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OSM' }).addTo(map);

// Inisialisasi Lokasi User
// --- KOORDINAT PUSAT KOTA BANDUNG (Alun-Alun Bandung) ---
// Koordinat Alun-Alun Bandung (pusat kota): -6.9218, 107.6083
const BANDUNG_LAT = -6.9218; 
const BANDUNG_LON = 107.6083; 
const BANDUNG_NAME = "Kota Bandung (Titik Awal)";

// 1. Atur tampilan peta default ke pusat Kota Bandung
map.setView([BANDUNG_LAT, BANDUNG_LON], 12); // Menggunakan zoom 12 untuk mencakup area kota yang lebih luas
document.getElementById('startLocation').value = BANDUNG_NAME;
document.getElementById('startLocation').dataset.lat = BANDUNG_LAT;
document.getElementById('startLocation').dataset.lon = BANDUNG_LON;

console.log(`Titik awal default diatur ke: ${BANDUNG_NAME}`);


// // 2. Coba Geolocation. Jika berhasil, timpa (override) nilai default
// if (navigator.geolocation) {
//     navigator.geolocation.getCurrentPosition(pos => {
//         const lat = pos.coords.latitude;
//         const lon = pos.coords.longitude;
        
//         // Ganti tampilan peta dan input dengan lokasi pengguna
//         map.setView([lat, lon], 13);
//         document.getElementById('startLocation').value = "My Location";
//         document.getElementById('startLocation').dataset.lat = lat;
//         document.getElementById('startLocation').dataset.lon = lon;
        
//         console.log("Titik awal berhasil diubah ke Posisi Saya.");
        
//     }, err => { 
//         // Geolocation gagal atau ditolak. Tetap gunakan Kota Bandung.
//         console.log('Geolocation gagal/ditolak. Menggunakan Kota Bandung sebagai titik awal.'); 
//     });
// }
// Variabel untuk menyimpan penanda lokasi dan proses pelacakan
let userLocationMarker = null;
let watchId = null;

// Ambil elemen tombol dari HTML
const locateButton = document.getElementById('locateBtn');
let userAccuracyCircle = null; // <-- TAMBAHKAN VARIABEL BARU INI
// Tambahkan event listener saat tombol di-klik
locateButton.addEventListener('click', () => {
    // Cek apakah browser mendukung Geolocation
    if (!navigator.geolocation) {
        console.error("Browser Anda tidak mendukung Geolocation.");
        return;
    }

    // Jika sedang melacak, hentikan pelacakan (fungsi toggle)
    if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        if (userLocationMarker) {
            map.removeLayer(userLocationMarker);
            userLocationMarker = null;
        }
        watchId = null;
        console.log("Pelacakan lokasi real-time dihentikan."); // Ganti alert dengan log
        return;
    }

    // // Jika belum melacak, mulai pelacakan
    // alert("Memulai pelacakan lokasi real-time. Izinkan akses lokasi jika diminta.");
    
    watchId = navigator.geolocation.watchPosition(
        (position) => {
            // --- FUNGSI JIKA LOKASI BERHASIL DIDAPAT ---
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const userLatLng = L.latLng(lat, lon);

            console.log("Lokasi baru terdeteksi:", userLatLng);

            // Jika penanda belum ada di peta, buat baru.
            if (!userLocationMarker) {
                userLocationMarker = L.marker(userLatLng, { 
                    icon: L.divIcon({
                        className: 'blinking-dot',
                        html: '<div style="background-color: #2563eb; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 15px #2563eb;"></div>',
                        iconSize: [20, 20],
                    }) 
                }).addTo(map);
                map.setView(userLatLng, 16); // Zoom lebih dekat saat pertama kali ditemukan
            } else {
                // Jika penanda sudah ada, pindahkan posisinya.
                userLocationMarker.setLatLng(userLatLng);
            }

            // Selalu update input Start Location
            const startInput = document.getElementById('startLocation');
            startInput.value = "My Location";
            startInput.dataset.lat = lat;
            startInput.dataset.lon = lon;
        },
        (error) => {
            // --- FUNGSI JIKA TERJADI ERROR ---
            console.error("Error saat melacak lokasi: ", error.message);
            navigator.geolocation.clearWatch(watchId); // Hentikan jika error
            watchId = null;
        },
        {
            // Opsi untuk pelacakan yang lebih akurat
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
});


// Base maps

const baseMaps = {
    "Satelit": L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {subdomains:['mt0','mt1','mt2','mt3']}),
    "Peta": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
    "Road Map": L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { 
        subdomains:['mt0','mt1','mt2','mt3']}),
    "Dark Matter": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/attributions">Carto</a>',
        subdomains: 'abcd',
        maxZoom: 20
    }),
};
baseMaps["Peta"].addTo(map);
// Tambahkan kontrol layer agar bisa switch base map
L.control.layers(baseMaps, null, { collapsed: false }).addTo(map);


// ====================================================================
// 2. LOGIKA ROUTING & AUTOCOMPLETE
// ====================================================================

// Autocomplete & suggestions
async function getSuggestions(query) {
    if(!query) return [];
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=ID&limit=5`);
    const data = await res.json();
    return data.map(item => ({ name: item.display_name, coords: [parseFloat(item.lat), parseFloat(item.lon)] }));
}

function setRouteDestination(lat, lon, name) {
    const endInput = document.getElementById('endLocation');
    const routeButton = document.getElementById('routeBtn');

    // 1. Set the destination input and data attributes
    endInput.value = name;
    endInput.dataset.lat = lat;
    endInput.dataset.lon = lon;

    // 2. Tutup pop-up (opsional, untuk UX yang lebih baik)
    map.closePopup();

    // 3. Panggil event klik pada tombol Rute
    routeButton.click();
}
window.setRouteDestination = setRouteDestination; // Pastikan fungsi dapat diakses secara global

function setupAutocomplete(inputId, suggestionsId) {
    const input = document.getElementById(inputId);
    const suggestionsDiv = document.getElementById(suggestionsId);
    input.addEventListener('input', async () => {
        const results = await getSuggestions(input.value);
        suggestionsDiv.innerHTML = results.map(r => `<div class="suggestion-item" data-lat="${r.coords[0]}" data-lon="${r.coords[1]}">${r.name}</div>`).join('');
    });
    suggestionsDiv.addEventListener('click', e => {
        if(e.target.classList.contains('suggestion-item')){
            input.value = e.target.textContent;
            input.dataset.lat = e.target.dataset.lat;
            input.dataset.lon = e.target.dataset.lon;
            suggestionsDiv.innerHTML = '';
        }
    });
    return () => {
        if(input.dataset.lat && input.dataset.lon) return [parseFloat(input.dataset.lat), parseFloat(input.dataset.lon)];
        return null;
    }
}

const getStartCoords = setupAutocomplete('startLocation', 'startSuggestions');
const getEndCoords = setupAutocomplete('endLocation', 'endSuggestions');

let routingControl;
document.getElementById('routeBtn').addEventListener('click', () => {
    const start = getStartCoords();
    const end = getEndCoords();
     const vehicle = document.querySelector('input[name="vehicle"]:checked')?.value;

    if(!start || !end) return alert('Pilih lokasi awal dan tujuan dari daftar saran');

    if(routingControl) map.removeControl(routingControl);

    routingControl = L.Routing.control({
        waypoints: [L.latLng(start[0], start[1]), L.latLng(end[0], end[1])],
        router: L.Routing.osrmv1({
            serviceUrl: 'https://router.project-osrm.org/route/v1',
            profile: vehicle
        }),
        routeWhileDragging: true,
        lineOptions: { styles: [{ color: 'red', opacity: 0.7, weight: 3, dashArray: '10,6' }] },
        createMarker: function(i, wp) { return L.marker(wp.latLng); }
    }).addTo(map);

    map.fitBounds([ L.latLng(start[0], start[1]), L.latLng(end[0], end[1]) ]);
});





// ... (Pastikan Anda menambahkan baris ini di awal script untuk mendapatkan elemen label)
const startLabel = document.querySelector('label[for="startLocation"]');
const endLabel = document.querySelector('label[for="endLocation"]');

// === LOGIKA SWAP LOKASI - PERBAIKAN START ===
document.getElementById('swapBtn').addEventListener('click', () => {
    const startInput = document.getElementById('startLocation');
    const endInput = document.getElementById('endLocation');
    // const startLabel = document.querySelector('label[for="startLocation"]'); // Asumsikan sudah didefinisikan
    // const endLabel = document.querySelector('label[for="endLocation"]');     // Asumsikan sudah didefinisikan

    // 1. Swap Nilai Input dan Koordinat (Sudah Benar)
    const tempValue = startInput.value;
    const tempLat = startInput.dataset.lat;
    const tempLon = startInput.dataset.lon;

    startInput.value = endInput.value;
    startInput.dataset.lat = endInput.dataset.lat;
    startInput.dataset.lon = endInput.dataset.lon;

    endInput.value = tempValue;
    endInput.dataset.lat = tempLat;
    endInput.dataset.lon = tempLon;

    // 2. TUKAR TEKS LABEL (BARU DITAMBAHKAN)
    
    const tempLabelText = startLabel.textContent;
    startLabel.textContent = endLabel.textContent;
    endLabel.textContent = tempLabelText;

    
 
    if (startInput.value && endInput.value) {
        document.getElementById('routeBtn').click();
    }
});
// === LOGIKA SWAP LOKASI - PERBAIKAN END ===



// ====================================================================
// 3. DEFINISI IKON KUSTOM (4 JENIS IKON DENGAN KELAS CSS BERBEDA)
// ====================================================================

// --- Base Options ---
const iconOptions = {
    iconSize: [30, 30], 
    iconAnchor: [15, 30], 
    popupAnchor: [0, -30], 
    className: 'futuristic-icon' // Kelas CSS dasar
};

// --- Definisi Ikon Spesifik ---
// Catatan: Kelas CSS spesifik ditambahkan ke className yang sudah ada
const natureIcon = L.icon({ ...iconOptions, iconUrl: '../Image/Marker/Marker_Nature2.png', className: iconOptions.className + ' icon-nature' });
const culinaryIcon = L.icon({ ...iconOptions, iconUrl: '../Image/Marker/Marker_Culinary.png', className: iconOptions.className + ' icon-culinary' });
const historyIcon = L.icon({ ...iconOptions, iconUrl: '../Image/Marker/Marker_Culture.png', className: iconOptions.className + ' icon-history' });
const recreationIcon = L.icon({ ...iconOptions, iconUrl: '../Image/Marker/Marker_Park.png', className: iconOptions.className + ' icon-recreation' });



// ====================================================================
// 4. FUNGSI MARKER DAN POPUP (MODULAR)
// ====================================================================

/**
 * Membuat marker kustom dan lingkaran glow.
 * @param {object} icon - Ikon Leaflet yang akan digunakan.
 */
function createPointMarker(icon) {
    return function (feature, latlng) {
        
        var marker = L.marker(latlng, { icon: icon });

        // Catatan: Glow lingkaran statis/hover di sini berisiko konflik dengan MarkerCluster,
        // tetapi kita pertahankan glow CSS pada ikon itu sendiri untuk efek futuristik.
        // Kita gunakan warna dasar dari CSS untuk lingkaran base glow ini.
        let glowColor;
        if(icon.options.className.includes('icon-nature')) glowColor = "rgba(0, 255, 150, 0.4)";
        else if(icon.options.className.includes('icon-culinary')) glowColor = "rgba(0, 150, 255, 0.4)";
        else if(icon.options.className.includes('icon-history')) glowColor = "rgba(255, 100, 0, 0.4)";
        else if(icon.options.className.includes('icon-recreation')) glowColor = "rgba(0, 255, 255, 0.7)";
        else glowColor = "rgba(180, 255, 200, 0.4)";

        var baseGlow = L.circleMarker(latlng, {
            radius: 12,
            fillColor: glowColor, 
            color: "transparent",
            weight: 0,
            fillOpacity: 0.8, // Sedikit lebih transparan
        }).addTo(map);

        // Logika Hover (Mengubah warna lingkaran)
        marker.on('mouseout', () => baseGlow.setStyle({ fillColor: glowColor }));
        marker.on('mouseover', () => baseGlow.setStyle({ 
            fillColor: L.DomUtil.get(marker._icon).style.borderColor.replace('1.0', '0.8') || glowColor.replace('0.4', '0.8')
        }));
        
        // Simpan referensi ke glow agar bisa dihapus jika diperlukan
        marker._glow = baseGlow;

        return marker; 
    };
}


/**
 * Membuat konten popup dan menambahkan logika aktif/non-aktif.
 */
function createPopupContent(feature, layer) {
    if (feature.properties && feature.properties.Nama) {
        const koordinatLat = feature.geometry.coordinates[1];
        const koordinatLon = feature.geometry.coordinates[0];
        
        // --- STRUKTUR HTML UNTUK POP-UP ---
        var popupContent = `
       <div style="width:280px; border-radius:12px; overflow:hidden; font-family:sans-serif; background:#fff; opacity:0.9;"> </div>
          <img src="${feature.properties.gambar}" style="width:100%; height:auto; max-height:160px; object-fit:cover; 
            border-top-left-radius: 10px; /* Radius sudut kiri atas */
            border-top-right-radius: 10px; /* Radius sudut kanan atas */
             border-bottom-left-radius: 10px;
             border-bottom-right-radius: 10px;">
          <div style="padding:10px; display:flex; flex-direction:column; justify-content:space-between;">
            <div>
              <h3 style="margin:0 0 5px 0; font-size:14px; font-weight:600; color:#777">${feature.properties.Kategori}</h3>
              <h3 style="margin:0 0 5px 0; font-size:16px; font-weight:600;">${feature.properties.Nama}</h3>
              <p style="margin:0 0 8px 0; font-size:13px; color:#555; line-height:1.3;">
                ${feature.properties.Jalan}, ${feature.properties.Kecamatan}, ${feature.properties.Kota}, ${feature.properties["Kabupaten/Kota"]}, ${feature.properties.Provinsi}
              </p>
              <p style="margin:0; font-size:13px; color:#333;">
                Koordinat:${feature.geometry.coordinates[1]}, ${feature.geometry.coordinates[0]}
              </p>
            </div>
                    <button onclick="setRouteDestination(${feature.geometry.coordinates[1]}, ${feature.geometry.coordinates[0]}, '${feature.properties.Nama}')"
        style="width:100%; text-align:center; margin-top:8px; padding:8px; font-size:13px; font-weight:600; color:white; background:#007BFF; border:none; border-radius:6px; cursor:pointer;">
        Lihat Rute
        </button>
            </a>
          </div>
        </div>
        `;
        
        layer.bindPopup(popupContent, { className: 'custom-popup-glow', maxWidth: 250 });
        
        // Logika Status Aktif/Glow
        layer.on({
            popupopen: (e) => e.target._icon.classList.add('marker-active'),
            popupclose: (e) => e.target._icon.classList.remove('marker-active')
        });
    }
}


// ====================================================================
// 5. PEMUATAN MULTI GEOJSON (4 FILE)
// ====================================================================

/**
 * Fungsi pembantu untuk memuat GeoJSON
 * @param {string} path - Path ke file GeoJSON
 * @param {object} icon - Ikon Leaflet yang akan digunakan
 * @param {string} layerName - Nama layer untuk console log
 */
function loadGeoJSONLayer(path, icon, layerName) {
    fetch(path)
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            // Definisikan opsi GeoJSON spesifik untuk layer ini
            const options = {
                pointToLayer: createPointMarker(icon),
                onEachFeature: createPopupContent
            };
            L.geoJSON(data, options).addTo(map); 
            console.log(`GeoJSON ${layerName} dimuat.`);
        })
        .catch(error => {
            console.error(`Gagal memuat GeoJSON ${layerName}:`, error);
        });
}


// Panggil fungsi untuk setiap file GeoJSON Anda


loadGeoJSONLayer(
    '../GEOJSON/LokasiWisataBudayaBandung.json', // Path 2
    historyIcon, 
    'Situs Sejarah'
);



</script>
</body>
</html>